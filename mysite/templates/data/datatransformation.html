<!DOCTYPE html>
<html lang="en" dir="ltr">
{% include "includes/head.html" %}


<body class="header-fixed sidebar-fixed sidebar-dark header-light" id="body">

    <script>
        NProgress.configure({
            showSpinner: false
        });
        NProgress.start();
    </script>

    <div class="mobile-sticky-body-overlay"></div>


    <div id="toaster"></div>


    <div class="wrapper">

        {% include "includes/leftsidebar.html" %}



        <div class="page-wrapper">
            <!-- Header -->
            {% include "includes/header.html" %}


            <div class="content-wrapper">
                <div class="content">

                    <div class="card card-default" id="dataframepreview">
                        <div class="card-header card-header-border-bottom">
                            <h2>Source DataFrame</h2>
                        </div>
                        <div class="card-body">

                            {% autoescape off %} {{dataframe}} {% endautoescape %}
                        </div>
                        <div class="card-footer d-flex flex-wrap bg-white">
                            <button id="addudf" type="button" class="btn btn-block btn-primary">Add UDF</button>
                        </div>
                        <script>
                            $('#addudf').click(
                                function () {
                                    //newudfinput = $('#originaludfinput').clone()
                                    /*newudfinput = $.parseHTML(
                                        '<div id="originaludfinput" class="card card-default">                <div class="card-header card-header-border-bottom">                  <h2>Define UDF</h2>                </div>                <div class="card-body">                  <p> Select Input Column from Dataframe <select                        class="js-example-basic-multiple form-control"                        name="columns"                        multiple="multiple"                        data-select2-id="columns1"                        tabindex="-1"                        aria-hidden="true"                      >                        //{% for c in columns %}                        <option value="{{ c }}">{{c}}</option>                        //{% endfor %}                      </select></p>                   <p>TextArea Python Code                  <textarea name="udfcode1" class="form-control" id="exampleFormControlTextarea1" rows="3" style="margin-top: 0px; margin-bottom: 0px; height: 122px;" ></textarea>                                    </p>                  <p>Multiple Selection of DataType                  <select                        class="js-example-basic-multiple form-control"                        name="columns"                        multiple="multiple"                        data-select2-id="output1"                        tabindex="-1"                        aria-hidden="true"                      >                        //{% for c in types %}                        <option value="{{ c }}">{{c}}</option>                        //{% endfor %}                      </select>                  </p>                  <br/>                  <p>                                                      <p>TODO: On creation; create preselect</p>                  </div>                  <div class="card-footer d-flex flex-wrap bg-white">                              <button type="button" class="btn btn-block btn-warning">Remove</button><p/>                            </div>                </div>'
                                        );
                                    $(newudfinput).find('[data-select2-id="output1"]').attr('data-select2-id',
                                        'ooxxx')
                                    $(newudfinput).find('[data-select2-id="columns1"]').attr('data-select2-id',
                                        'ccxxx')
                                    $('#dataframepreview').after(newudfinput)
                                    $('[data-select2-id="ooxxx"]').select2()
                                    $('[data-select2-id="ccxxx"]').select2()*/
                                    var newinput = $("#originaludfinput").clone()
                                    $('#dataframepreview').after(newinput)
                                }
                            )
                        </script>
                    </div>
                    
                    <div id="originaludfinput" class="card card-default">
                        <form id="originaludfinputForm" enctype="multipart/form-data"
                            action="{% url 'transformdata' project.pk %}" method='POST'>
                            {% csrf_token %}
                            <div class="card-header card-header-border-bottom">
                                <h2>Define UDF</h2>
                            </div>
                            <div class="card-body">
                                <p> Select Input Column from Dataframe <select
                                        class="js-example-basic-multiple form-control" name="columns"
                                        multiple="multiple" data-select2-id="columns1" tabindex="-1" aria-hidden="true">
                                        //{% for c in columns %}
                                        <option value="{{ c }}">{{c}}</option>
                                        //{% endfor %}
                                    </select></p>
                                <p>TextArea Python Code
                                    <div id="container_1" class="monacoeditor notready" style="height:200px"></div>
                                </p>
                                <p>Multiple Selection of DataType
                                
                                <ol class="breadcrumb breadcrumb-inverse">
                                    <li class="breadcrumb-item">
                                        <a onclick="removeBredCrump(this)">StringType</a>
                                    </li>
                                </ol>
                                
                                <div class="dropdown d-inline-block mb-1">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
                                        Add Type
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <!--{% for c in types %}-->
                                        <a class="dropdown-item" onclick="addBredCrump(this,'{{c}}')">{{c}}</a>
                                        <!--{% endfor %}-->
                                    </div>
                                </div>
                                </p>
                                
                                <br />
                                <p>TODO: On creation; create preselect</p>
                            </div>
                            <div class="card-footer d-flex flex-wrap bg-white">
                                <button type="button" id="saveandtestudffunction" class="btn btn-block btn-primary">Save and Test UDF</button>
                                <button type="button" class="btn btn-block btn-warning">Remove UDF</button>
                                <br/>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card card-default">
                        <div class="card-header card-header-border-bottom">
                            <h2>Apply Transformation</h2>
                        </div>
                        <div class="card-body">
                            <form enctype="multipart/form-data" action="{% url 'transformdata' project.pk %}"
                                method='POST'>
                                {% csrf_token %}
                                <label for="exampleFormControlTextarea1">Define UDFs</label>
                                <textarea name="udfclasses" class="form-control" id="exampleFormControlTextarea1"
                                    rows="3" style="margin-top: 0px; margin-bottom: 0px; height: 122px;visibility:hidden;display:None"
                                    value="{{udfclasses}}">{{udfclasses}}</textarea>
                                <div id="udfclassesmonacoeditor" class="monacoeditor notready" style="height:200px"></div>
                                <label for="exampleFormControlInput1">Provide Select Statement</label>
                                <input type="text" name="selectstatement" class="form-control"
                                    id="exampleFormControlInput1" placeholder='select("*")' value="{{selectstatement}}">
                                <br />
                                <button type="submit" class="btn btn-primary">Transform</button>
                            </form>
                        </div>
                    </div>

                    <div class="card card-default">
                        <div class="card-header card-header-border-bottom">
                            <h2>Target DataFrame</h2>
                        </div>
                        <div class="card-body">

                            {% autoescape off %} {{dataframe2}} {% endautoescape %}
                        </div>
                    </div>
                </div>
            </div>

            {% include "includes/footer.html" %}

        </div>
    </div>

    <script>
        function removeBredCrump(e){
            $(e).parent().remove()
        }

        function getTypeValueOfBredCrump(){
            return $.map($('#originaludfinputForm').find('ol.breadcrumb').find('a'), (val,i) => val.text).join()
        }
        
        sparktypes = {}
        //{% for key,value in types.items %}
        sparktypes['{{key}}'] = '{{value}}';
        //{% endfor %}
        

        function addBredCrump(e,type){
            txt = '<li class="breadcrumb-item"><a onclick="removeBredCrump(this)" >'+type+'</a></li>'
            
            var tocheck = $(e).parent().parent().parent().parent().find('ol.breadcrumb').find('a').last().text()
            if(sparktypes[tocheck] != "False"){
                $(e).parent().parent().parent().parent().find('ol.breadcrumb').append(txt)
            }
        }

        $("form").submit(function(e){
            value = $("#udfclassesmonacoeditor")[0].editor.getModel().getValue()
            $("[name=udfclasses]").val(value)
        })
        function setupMonacoEditor() {
            alleditors = $(".monacoeditor, .notready")
            alleditors.each(
                function(){
                    this.editor = monaco.editor.create(this, {
                    value: "return output",
                    language: "python",
                    automaticLayout: true
                });
                }
            )
            alleditors.removeClass("notready")
            value = $("[name=udfclasses]").val()
            $("#udfclassesmonacoeditor")[0].editor.getModel().setValue(value)

            
        }
        if (!monaco) {
            setTimeout(setupMonacoEditor, 200)
        } else {
            setupMonacoEditor()
        }

        $("#saveandtestudffunction").click(function (e) {
            var udfvalue = $(e.target).parent().parent().find('.monacoeditor')[0].editor.getValue()
            var outputtype = $.map($(e.target).parent().parent().find('ol.breadcrumb').find('a'), (val,i) => val.text).join()
            
            $.post("{% url 'createOrUpdateUDF' project.pk %}", 
                {
                    "csrfmiddlewaretoken":"{{ csrf_token }}",
                    "udfcode1": udfvalue,
                    "columns": $(e.target).parent().parent().find('[name=columns]').select2('data').map(x => x.text).join(","),
                    "outputtype": outputtype
                },
                function (data) {
                    console.log(data);
                    
                });
            e.preventDefault();
        });
    </script>


    {% include "includes/scripts.html" %}
</body>

</html>